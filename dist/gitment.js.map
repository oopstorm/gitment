{"version":3,"sources":["../src/gitment.js"],"names":["scope","extendRenderer","instance","renderer","container","targetContainer","render","theme","defaultTheme","e","state","firstChild","replaceChild","appendChild","Gitment","localStorage","getItem","LS_ACCESS_TOKEN_KEY","token","setItem","oauthUri","redirect_uri","oauth","window","location","href","oauthParams","Object","assign","Query","stringify","options","useTheme","id","title","document","link","desc","labels","perPage","maxCommentHeight","user","userInfo","LS_USER_KEY","accessToken","JSON","parse","fromCache","removeItem","error","meta","comments","undefined","reactions","commentReactions","currentPage","query","code","client_id","client_secret","search","replacedUrl","origin","pathname","hash","history","replaceState","isLoggingIn","http","post","then","data","access_token","update","catch","alert","createIssue","loadComments","renderers","keys","forEach","Promise","all","loadMeta","loadUserInfo","loadCommentReactions","loadReactions","text","mode","owner","repo","concat","body","resolve","getIssue","issue","comments_url","pageCount","Math","ceil","push","admin","get","issues","length","allowed","map","x","toLowerCase","filter","indexOf","login","sort","left","right","Date","created_at","reject","NOT_INITIALIZED_ERROR","page","per_page","logout","total_count","url","comentReactions","comment","index","reactionsArray","loginLink","number","content","reaction","heart","findIndex","delete","splice","commentId","find","module","exports"],"mappings":"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","file":"gitment.js","sourcesContent":["import { autorun, observable } from 'mobx'\r\n\r\nimport { LS_ACCESS_TOKEN_KEY, LS_USER_KEY, NOT_INITIALIZED_ERROR } from './constants'\r\nimport { getTargetContainer, http, Query } from './utils'\r\nimport defaultTheme from './theme/default'\r\n\r\nconst scope = 'public_repo'\r\n\r\nfunction extendRenderer(instance, renderer) {\r\n  instance[renderer] = (container) => {\r\n    const targetContainer = getTargetContainer(container)\r\n    const render = instance.theme[renderer] || instance.defaultTheme[renderer]\r\n\r\n    autorun(() => {\r\n      const e = render(instance.state, instance)\r\n      if (targetContainer.firstChild) {\r\n        targetContainer.replaceChild(e, targetContainer.firstChild)\r\n      } else {\r\n        targetContainer.appendChild(e)\r\n      }\r\n    })\r\n\r\n    return targetContainer\r\n  }\r\n}\r\n\r\nclass Gitment {\r\n  get accessToken() {\r\n    return localStorage.getItem(LS_ACCESS_TOKEN_KEY)\r\n  }\r\n  set accessToken(token) {\r\n    localStorage.setItem(LS_ACCESS_TOKEN_KEY, token)\r\n  }\r\n\r\n  get loginLink() {\r\n    const oauthUri = 'https://github.com/login/oauth/authorize'\r\n    const redirect_uri = this.oauth.redirect_uri || window.location.href\r\n\r\n    const oauthParams = Object.assign({\r\n      scope,\r\n      redirect_uri,\r\n    }, this.oauth)\r\n\r\n    return `${oauthUri}${Query.stringify(oauthParams)}`\r\n  }\r\n\r\n  constructor(options = {}) {\r\n    this.defaultTheme = defaultTheme\r\n    this.useTheme(defaultTheme)\r\n\r\n    Object.assign(this, {\r\n      id: window.location.href,\r\n      title: window.document.title,\r\n      link: window.location.href,\r\n      desc: '',\r\n      labels: [],\r\n      theme: defaultTheme,\r\n      oauth: {},\r\n      perPage: 20,\r\n      maxCommentHeight: 250,\r\n    }, options)\r\n\r\n    this.useTheme(this.theme)\r\n\r\n    const user = {}\r\n    try {\r\n      const userInfo = localStorage.getItem(LS_USER_KEY)\r\n      if (this.accessToken && userInfo) {\r\n        Object.assign(user, JSON.parse(userInfo), {\r\n          fromCache: true,\r\n        })\r\n      }\r\n    } catch (e) {\r\n      localStorage.removeItem(LS_USER_KEY)\r\n    }\r\n\r\n    this.state = observable({\r\n      user,\r\n      error: null,\r\n      meta: {},\r\n      comments: undefined,\r\n      reactions: [],\r\n      commentReactions: {},\r\n      currentPage: 1,\r\n    })\r\n\r\n    const query = Query.parse()\r\n    if (query.code) {\r\n      const { client_id, client_secret } = this.oauth\r\n      const code = query.code\r\n      delete query.code\r\n      const search = Query.stringify(query)\r\n      const replacedUrl = `${window.location.origin}${window.location.pathname}${search}${window.location.hash}`\r\n      history.replaceState({}, '', replacedUrl)\r\n\r\n      Object.assign(this, {\r\n        id: replacedUrl,\r\n        link: replacedUrl,\r\n      }, options)\r\n\r\n      this.state.user.isLoggingIn = true\r\n      http.post('https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token', {\r\n          code,\r\n          client_id,\r\n          client_secret,\r\n        }, '')\r\n        .then(data => {\r\n          this.accessToken = data.access_token\r\n          this.update()\r\n        })\r\n        .catch(e => {\r\n          this.state.user.isLoggingIn = false\r\n          alert(e)\r\n        })\r\n    } else {\r\n      this.update()\r\n    }\r\n  }\r\n\r\n  init() {\r\n    return this.createIssue()\r\n      .then(() => this.loadComments())\r\n      .then(comments => {\r\n        this.state.error = null\r\n        return comments\r\n      })\r\n  }\r\n\r\n  useTheme(theme = {}) {\r\n    this.theme = theme\r\n\r\n    const renderers = Object.keys(this.theme)\r\n    renderers.forEach(renderer => extendRenderer(this, renderer))\r\n  }\r\n\r\n  update() {\r\n    return Promise.all([this.loadMeta(), this.loadUserInfo()])\r\n      .then(() => Promise.all([\r\n        this.loadComments().then(() => this.loadCommentReactions()),\r\n        this.loadReactions(),\r\n      ]))\r\n      .catch(e => this.state.error = e)\r\n  }\r\n\r\n  markdown(text) {\r\n    return http.post('/markdown', {\r\n      text,\r\n      mode: 'gfm',\r\n    })\r\n  }\r\n\r\n  createIssue() {\r\n    const { id, owner, repo, title, link, desc, labels } = this\r\n\r\n    return http.post(`/repos/${owner}/${repo}/issues`, {\r\n      title,\r\n      labels: labels.concat(['gitment', id]),\r\n      body: `${link}\\n\\n${desc}`,\r\n    })\r\n      .then((meta) => {\r\n        this.state.meta = meta\r\n        return meta\r\n      })\r\n  }\r\n\r\n  getIssue() {\r\n    if (this.state.meta.id) return Promise.resolve(this.state.meta)\r\n\r\n    return this.loadMeta()\r\n  }\r\n\r\n  post(body) {\r\n    return this.getIssue()\r\n      .then(issue => http.post(issue.comments_url, { body }, ''))\r\n      .then(data => {\r\n        this.state.meta.comments++\r\n        const pageCount = Math.ceil(this.state.meta.comments / this.perPage)\r\n        if (this.state.currentPage === pageCount) {\r\n          this.state.comments.push(data)\r\n        }\r\n        return data\r\n      })\r\n  }\r\n\r\n  loadMeta() {\r\n    const { id, admin, owner, repo } = this\r\n    return http.get(`/repos/${owner}/${repo}/issues`, {\r\n        labels: id,\r\n      })\r\n      .then(issues => {\r\n        if (issues.length) {\r\n          let allowed = (admin || [owner]).map(x=>x.toLowerCase())\r\n          issues = issues.filter(issue => ~allowed.indexOf(issue.user.login.toLowerCase()))\r\n            .sort((left, right) => new Date(left.created_at) - new Date(right.created_at))\r\n        }\r\n        if (!issues.length) return Promise.reject(NOT_INITIALIZED_ERROR)\r\n        this.state.meta = issues[0]\r\n        return issues[0]\r\n      })\r\n  }\r\n\r\n  loadComments(page = this.state.currentPage) {\r\n    return this.getIssue()\r\n      .then(issue => http.get(issue.comments_url, { page, per_page: this.perPage }, ''))\r\n      .then((comments) => {\r\n        this.state.comments = comments\r\n        return comments\r\n      })\r\n  }\r\n\r\n  loadUserInfo() {\r\n    if (!this.accessToken) {\r\n      this.logout()\r\n      return Promise.resolve({})\r\n    }\r\n\r\n    return http.get('/user')\r\n      .then((user) => {\r\n        this.state.user = user\r\n        localStorage.setItem(LS_USER_KEY, JSON.stringify(user))\r\n        return user\r\n      })\r\n  }\r\n\r\n  loadReactions() {\r\n    if (!this.accessToken) {\r\n      this.state.reactions = []\r\n      return Promise.resolve([])\r\n    }\r\n\r\n    return this.getIssue()\r\n      .then((issue) => {\r\n        if (!issue.reactions.total_count) return []\r\n        return http.get(issue.reactions.url, {}, '')\r\n      })\r\n      .then((reactions) => {\r\n        this.state.reactions = reactions\r\n        return reactions\r\n      })\r\n  }\r\n\r\n  loadCommentReactions() {\r\n    if (!this.accessToken) {\r\n      this.state.commentReactions = {}\r\n      return Promise.resolve([])\r\n    }\r\n\r\n    const comments = this.state.comments\r\n    const comentReactions = {}\r\n\r\n    return Promise.all(comments.map((comment) => {\r\n      if (!comment.reactions.total_count) return []\r\n\r\n      const { owner, repo } = this\r\n      return http.get(`/repos/${owner}/${repo}/issues/comments/${comment.id}/reactions`, {})\r\n    }))\r\n      .then(reactionsArray => {\r\n        comments.forEach((comment, index) => {\r\n          comentReactions[comment.id] = reactionsArray[index]\r\n        })\r\n        this.state.commentReactions = comentReactions\r\n\r\n        return comentReactions\r\n      })\r\n  }\r\n\r\n  login() {\r\n    window.location.href = this.loginLink\r\n  }\r\n\r\n  logout() {\r\n    localStorage.removeItem(LS_ACCESS_TOKEN_KEY)\r\n    localStorage.removeItem(LS_USER_KEY)\r\n    this.state.user = {}\r\n  }\r\n\r\n  goto(page) {\r\n    this.state.currentPage = page\r\n    this.state.comments = undefined\r\n    return this.loadComments(page)\r\n  }\r\n\r\n  like() {\r\n    if (!this.accessToken) {\r\n      alert('Login to Like')\r\n      return Promise.reject()\r\n    }\r\n\r\n    const { owner, repo } = this\r\n\r\n    return http.post(`/repos/${owner}/${repo}/issues/${this.state.meta.number}/reactions`, {\r\n      content: 'heart',\r\n    })\r\n      .then(reaction => {\r\n        this.state.reactions.push(reaction)\r\n        this.state.meta.reactions.heart++\r\n      })\r\n  }\r\n\r\n  unlike() {\r\n    if (!this.accessToken) return Promise.reject()\r\n\r\n\r\n    const { user, reactions } = this.state\r\n    const index = reactions.findIndex(reaction => reaction.user.login === user.login)\r\n    return http.delete(`/reactions/${reactions[index].id}`)\r\n      .then(() => {\r\n        reactions.splice(index, 1)\r\n        this.state.meta.reactions.heart--\r\n      })\r\n  }\r\n\r\n  likeAComment(commentId) {\r\n    if (!this.accessToken) {\r\n      alert('Login to Like')\r\n      return Promise.reject()\r\n    }\r\n\r\n    const { owner, repo } = this\r\n    const comment = this.state.comments.find(comment => comment.id === commentId)\r\n\r\n    return http.post(`/repos/${owner}/${repo}/issues/comments/${commentId}/reactions`, {\r\n      content: 'heart',\r\n    })\r\n      .then(reaction => {\r\n        this.state.commentReactions[commentId].push(reaction)\r\n        comment.reactions.heart++\r\n      })\r\n  }\r\n\r\n  unlikeAComment(commentId) {\r\n    if (!this.accessToken) return Promise.reject()\r\n\r\n    const reactions = this.state.commentReactions[commentId]\r\n    const comment = this.state.comments.find(comment => comment.id === commentId)\r\n    const { user } = this.state\r\n    const index = reactions.findIndex(reaction => reaction.user.login === user.login)\r\n\r\n    return http.delete(`/reactions/${reactions[index].id}`)\r\n      .then(() => {\r\n        reactions.splice(index, 1)\r\n        comment.reactions.heart--\r\n      })\r\n  }\r\n}\r\n\r\nmodule.exports = Gitment\r\n"]}